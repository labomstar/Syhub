<style>
  [x-cloak] {
    display: none !important;
  }
</style>

<div class="filters text-sm space-y-6">
  <!-- Availability Filter -->
  <div>
    <h3 class="font-semibold mb-2">Filter</h3>
    <ul class="space-y-2">
      <li>
        <label class="flex items-center gap-2 cursor-pointer">
          <input
            type="checkbox"
            onchange="
              let searchParams = new URLSearchParams(window.location.search);
              if(this.checked) {
                searchParams.set('filter.v.availability', '1');
              } else {
                searchParams.delete('filter.v.availability');
              }
              if (!searchParams.has('sort_by')) {
                searchParams.set('sort_by', '{{ collection.sort_by | default: 'manual' }}');
              }
              window.location.href = window.location.pathname + '?' + searchParams.toString();
            "
            {% if current_tags contains 'In Stock' or request.params['filter.v.availability'] == '1' %}
              checked
            {% endif %}
          >
          <span>In stock</span>
        </label>
      </li>
    </ul>
  </div>

  <!-- Brand Filter -->
  {% assign vendor_values = '' %}
  {% for product in collection.all_products %}
    {% unless vendor_values contains product.vendor %}
      {% assign vendor_values = vendor_values | append: product.vendor | append: ',' %}
    {% endunless %}
  {% endfor %}
  {% assign vendor_array = vendor_values | split: ',' | uniq | compact %}

  {% if vendor_array.size > 0 %}
    <div x-data="{ showAll: false }">
      <h3 class="font-semibold mb-2">Brand</h3>
      <ul class="space-y-2">
        {% for value in vendor_array %}
          {% if forloop.index <= 5 %}
            {% assign is_first_five = true %}
          {% else %}
            {% assign is_first_five = false %}
          {% endif %}
          <li x-show="{{ is_first_five | json }} || showAll" x-cloak>
            <label class="flex items-center gap-2 cursor-pointer">
              <input
                type="checkbox"
                onchange="
                  let searchParams = new URLSearchParams(window.location.search);
                  if(this.checked) {
                    searchParams.set('filter.p.vendor', '{{ value }}');
                  } else {
                    searchParams.delete('filter.p.vendor');
                  }
                  if (!searchParams.has('sort_by')) {
                    searchParams.set('sort_by', '{{ collection.sort_by | default: 'manual' }}');
                  }
                  window.location.href = window.location.pathname + '?' + searchParams.toString();
                "
                {% if request.params['filter.p.vendor'] == value %}
                  checked
                {% endif %}
              >
              <span>{{ value }}</span>
              <span class="text-gray-400 text-xs">({{ collection.all_products | where: 'vendor', value | size }})</span>
            </label>
          </li>
        {% endfor %}
      </ul>

      {% if vendor_array.size > 5 %}
        <button @click="showAll = !showAll" class="text-pink-600 text-xs mt-2">
          <span x-show="!showAll">Show more ▼</span>
          <span x-show="showAll">Show less ▲</span>
        </button>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
  function priceFilter() {
    return {
      minPrice: '',
      maxPrice: '',
      applyFilter() {
        // نحتفظ بكل الفلاتر الموجودة في URL
        let searchParams = new URLSearchParams(window.location.search);

        // تحديث أو حذف فلتر السعر الأدنى
        if (this.minPrice) {
          searchParams.set('filter.v.price.gte', this.minPrice);
        } else {
          searchParams.delete('filter.v.price.gte');
        }

        // تحديث أو حذف فلتر السعر الأعلى
        if (this.maxPrice) {
          searchParams.set('filter.v.price.lte', this.maxPrice);
        } else {
          searchParams.delete('filter.v.price.lte');
        }

        // الاحتفاظ بالسورت أو إضافة القيمة الافتراضية
        if (!searchParams.has('sort_by')) {
          searchParams.set('sort_by', '{{ collection.sort_by | default: 'manual' }}');
        }

        // تحويل كل الفلاتر إلى URL والانتقال للرابط
        window.location.href = window.location.pathname + '?' + searchParams.toString();
      },
    };
  }
</script>
