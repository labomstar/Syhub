<div
  id="corner-popup"
  class="fixed bottom-4 left-4 bg-white rounded-lg shadow-lg flex items-center gap-3 p-4 w-80 max-w-xs cursor-pointer z-50 hidden"
>
  <div class="w-20 h-20 flex-shrink-0">
    <img id="popup-product-image" class="object-cover w-20 h-20 rounded" alt="Product">
  </div>

  <div class="flex-1 flex flex-col justify-between">
    <div>
      <p class="text-sm text-gray-500">{{ settings.random_product_popup_title }}</p>
      <h3 id="popup-product-title" class="font-bold text-gray-800 truncate"></h3>
      <p id="popup-product-description" class="text-gray-600 text-sm line-clamp-2"></p>
    </div>
    <p class="text-xs text-gray-400 mt-2"><span id="popup-time">8 minutes ago</span> · view</p>
    <span class="">{{ settings.popup_random_product_content }}</span>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const products = {{ collections.all.products | json }};
  if (!products || products.length === 0) return;

  const popup = document.getElementById('corner-popup');
  const imgEl = document.getElementById('popup-product-image');
  const titleEl = document.getElementById('popup-product-title');
  const descEl = document.getElementById('popup-product-description');
  const timeEl = document.getElementById('popup-time');

  function updatePopup() {
    const randomIndex = Math.floor(Math.random() * products.length);
    const product = products[randomIndex];

    // رابط الصورة الآمن
    imgEl.src = (product.featured_image && product.featured_image.src) 
    ? product.featured_image.src | img_url: 'medium' 
    : '{{ "Luliz_Logo.png" | asset_url }}';
    imgEl.alt = product.title;

    titleEl.textContent = product.title;
    descEl.textContent = product.description ? product.description.replace(/(<([^>]+)>)/gi, "").substring(0, 80) : '';

    const minutesAgo = Math.floor(Math.random() * 9) + 2; // 2-10 دقائق
    timeEl.textContent = `${minutesAgo} minutes ago`;

    popup.classList.remove('hidden');
    popup.onclick = () => window.location.href = product.url;
  }

  setTimeout(updatePopup, 1000);

  function scheduleNextPopup() {
    const delayMinutes = Math.floor(Math.random() * 9) + 2;
    const delayMs = delayMinutes * 60 * 1000;
    setTimeout(() => {
      updatePopup();
      scheduleNextPopup();
    }, delayMs);
  }

  scheduleNextPopup();
});
</script>
