<div id="corner-popup" class="fixed bottom-4 left-4 z-50"></div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const products = {{ collections.all.products | json }};
    if (!products || products.length === 0) return;

    const popup = document.getElementById('corner-popup');

    // نعمل لوب على كل المنتجات
    products.forEach((product, index) => {
      // ننضف وصف المنتج من الـ HTML ونقصه
      const shortDesc = product.description 
        ? product.description.replace(/(<([^>]+)>)/gi, "").substring(0, 80)
        : '';

      // نبني HTML لكل منتج
      const productHTML = `
        <div class="bg-white rounded-lg shadow-lg flex items-center gap-3 p-4 w-80 max-w-xs cursor-pointer mb-3 hidden product-popup" data-url="${product.url}">
          <!-- product image -->
          <div class="w-20 h-20 flex-shrink-0">
            <img src="${product.featured_image ? product.featured_image.src + `| img_url` : '{{ "Luliz_Logo.png" | asset_url }}'}" 
                 alt="${product.title}" 
                 class="object-cover w-full h-full rounded" 
                 width="80" height="80">
          </div>

          <!-- product info -->
          <div class="flex-1 flex flex-col justify-between">
            <div>
              <p class="text-sm text-gray-500">{{ settings.random_product_popup_title | escape }}</p>
              <h3 class="font-bold text-gray-800 truncate">${product.title}</h3>
              <p class="text-gray-600 text-sm line-clamp-2">${shortDesc}</p>
            </div>
            <p class="text-xs text-gray-400 mt-2"><span>${Math.floor(Math.random() * 9) + 2} minutes ago</span> · view</p>
          </div>
        </div>
      `;

      // نضيف البلوك داخل الـ popup
      popup.insertAdjacentHTML("beforeend", productHTML);
    });

    // نجيب كل البوب أب ونخليهم يظهروا واحد ورا الثاني
    const popups = document.querySelectorAll('.product-popup');
    let current = 0;

    function showNextPopup() {
      // نخفي الكل
      popups.forEach(p => p.classList.add('hidden'));

      // نظهر واحد فقط
      popups[current].classList.remove('hidden');

      // عند الضغط على أي بوب أب يفتح رابط المنتج
      popups[current].addEventListener('click', () => {
        window.location.href = popups[current].dataset.url;
      });

      // نغير للمنتج التالي كل 5 ثواني
      current = (current + 1) % popups.length;
      setTimeout(showNextPopup, 5000);
    }

    // نبدأ العرض بعد ثانية
    setTimeout(showNextPopup, 1000);
  });
</script>
