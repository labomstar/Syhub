<!-- RANDOM PRODUCT POPUP -->
<div
  id="corner-popup"
  class="fixed bottom-4 left-4 bg-white rounded-lg shadow-lg p-4 w-80 max-w-xs cursor-pointer z-50 hidden"
>
  <!-- product info -->
  <div class="flex-1 flex flex-col justify-between">
    <p class="text-sm text-gray-500">{{ settings.random_product_popup_title }}</p>
    <div class="flex items-center space-x-3 mt-2">
      <img
        id="popup-product-image"
        src=""
        alt="Product Image"
        class="w-12 h-12 object-cover rounded"
        width=""
        height=""
      >
      <div class="flex-1 flex flex-col justify-between px-4">
        <h3 id="popup-product-title" class="font-bold text-gray-800 truncate overflow-ellipsis"></h3>
        <p id="popup-product-description" class="text-gray-600 text-sm line-clamp-2 overflow-ellipsis"></p>
      </div>
    </div>
    <p class="text-xs text-gray-400 mt-2"><span id="popup-time">8 minutes ago</span> · view</p>
  </div>
  {% comment %} <span class="">{{ settings.popup_random_product_content }}</span> {% endcomment %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const products = {{ collections.all.products | json }};
    if (products.length === 0) return;

    const randomIndex = Math.floor(Math.random() * products.length);
    const product = products[randomIndex];

    const popup = document.getElementById('corner-popup');
    const imgEl = document.getElementById('popup-product-image');
    const titleEl = document.getElementById('popup-product-title');
    const descEl = document.getElementById('popup-product-description');
    const timeEl = document.getElementById('popup-time');

    console.log(product);

    // صورة المنتج
    if (product.featured_image) {
      imgEl.src = product.featured_image;
    } else {
      imgEl.src = '{{ "Luliz_Logo.png" | asset_url }}';
    }
    imgEl.alt = product.title;

    // عنوان + وصف
    titleEl.textContent = product.title;
    descEl.textContent = product.description 
      ? product.description.replace(/(<([^>]+)>)/gi, "").substring(0, 80) 
      : '';

    // وقت وهمي
    const minutesAgo = Math.floor(Math.random() * 9) + 2;
    timeEl.textContent = `${minutesAgo} minutes ago`;

    // إظهار البوب أب بعد ثانية
    setTimeout(() => popup.classList.remove('hidden'), 1000);

    // عند الضغط على البوب أب يفتح صفحة المنتج
    const productUrl = `/products/${product.handle}`; // الرابط الصحيح
    popup.addEventListener('click', (e) => {
      {% comment %} if (e.target !== closeBtn) { {% endcomment %}
        window.location.href = productUrl;
      {% comment %} } {% endcomment %}
    });
});
</script>
