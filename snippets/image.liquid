{% doc %}
  Renders a responsive image that might be wrapped in a link.

  When `width`, `height` and `crop` are provided, the image will be rendered
  with a fixed aspect ratio.

  @param {image} image - The image to be rendered
  @param {string} [url] - Optional destination URL for the image
  @param {string} [class] - Optional class to be added to the image wrapper
  @param {string} [id] - Optional id for the image
  @param {string} [alt] - Alternative text for the image
  @param {number} [width] - Max width of the image
  @param {number} [height] - Max height of the image
  @param {string} [crop] - Crop position of the image
  @param {string} [loading] - Lazy/eager loading (default: lazy)
  @param {string} [decoding] - async/sync decoding (default: async)
  @param {string} [sizes] - Responsive sizes attribute
  @param {boolean} [preload] - If true, adds a <link rel="preload"> tag for the image and forces loading="eager" with fetchpriority="high".
  @param {string} [fetchpriority] - Image fetch priority hint (auto | high | low).
{% enddoc %}

{% liquid
  if url
    assign wrapper = 'a'
  else
    assign wrapper = 'div'
  endif

  assign alt_text = alt | default: image.alt | escape
  assign loading_attr = loading | default: null
  assign decoding_attr = decoding | default: 'async'
  assign fetchpriority_attr = fetchpriority | default: 'auto'
  assign sizes_attr = sizes | default: '(max-width: 768px) 100vw, 50vw'
  assign preload_attr = preload | default: false
%}

<{{ wrapper }}
  class="image relative overflow-hidden {{ class }}"
  {% if url %}
    href="{{ url }}"
  {% endif %}
>
  {% if crop and width and height %}
    {{-
      image
      | image_url: width: width, height: height, crop: crop
      | image_tag: id: id, alt: alt_text, loading: preload_attr
      | default: loading_attr
      | default: 'lazy', decoding: decoding_attr, sizes: sizes_attr, fetchpriority: preload_attr
      | default: fetchpriority_attr, width: width, height: height
    -}}
  {% elsif width and height %}
    {{-
      image
      | image_url: width: width, height: height
      | image_tag: id: id, alt: alt_text, loading: preload_attr
      | default: loading_attr
      | default: 'lazy', decoding: decoding_attr, sizes: sizes_attr, fetchpriority: preload_attr
      | default: fetchpriority_attr, width: width, height: height
    -}}
  {% elsif width %}
    {{-
      image
      | image_url: width: width
      | image_tag: id: id, alt: alt_text, loading: preload_attr
      | default: loading_attr
      | default: 'lazy', decoding: decoding_attr, sizes: sizes_attr, fetchpriority: preload_attr
      | default: fetchpriority_attr, width: width
    -}}
  {% else %}
    {{-
      image
      | image_tag: id: id, alt: alt_text, class: class, loading: preload_attr
      | default: loading_attr
      | default: 'lazy', decoding: decoding_attr, sizes: sizes_attr, fetchpriority: preload_attr
      | default: fetchpriority_attr
    -}}
  {% endif %}
</{{ wrapper }}>
