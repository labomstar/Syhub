{% assign box_width = settings.body_width %}
{% assign swiper = section.settings.swiper_view %}
{% assign item_in_row = section.settings.item_in_row %}
{% assign pagination_row = section.settings.show_pagination_row %}
{% assign swiper_class = 'swiper mySwiper-' | append: section.id %}
{% assign my_swiper_class = 'mySwiper-' | append: section.id %}
{% assign next_button_class = 'swiper-next-' | append: section.id %}
{% assign prev_button_class = 'swiper-prev-' | append: section.id %}

{% assign reference_product_id = nil %}
{% if product %}
  {% assign reference_product_id = product.id %}
{% elsif cart and cart.items.size > 0 %}
  {% assign reference_product_id = cart.items.first.product.id %}
{% endif %}

<div 
  class="product-recommendations {{ box_width }} mx-auto bg-white"
  {% if reference_product_id %}
    data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ reference_product_id }}&limit=4&intent=related"
  {% endif %}
>
  {% if product and recommendations.performed? and recommendations.products_count > 0 %}
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      
      <!-- العنوان -->
      <div class="text-center mb-8">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900">
          {% if recommendations.intent == 'complementary' %}
            Pair it with
          {% else %}
            You may also like
          {% endif %}
        </h2>
      </div>

      {% assign layout_class = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-' | append: item_in_row | append: ' gap-6' %}
      {% if swiper %}{% assign layout_class = swiper_class %}{% endif %}

      <!-- المنتجات -->
      <div class="{{ layout_class }}">
        {% if swiper %}<div class="swiper-wrapper">{% endif %}
          {% for product in recommendations.products %}
            <div class="swiper-slide flex justify-center items-center">
              {%- render 'product-card', product: product -%}
            </div>
          {% endfor %}
        {% if swiper %}</div>{% endif %}
      </div>

      <!-- أزرار السوايبر -->
      {% if pagination_row and swiper %}
        <div class="{{ next_button_class }} swiper-button-next bg-white shadow-md rounded-full w-10 h-10 flex items-center justify-center text-gray-700 hover:bg-gray-100 transition absolute top-1/2 -translate-y-1/2 right-2 z-10"></div>
        <div class="{{ prev_button_class }} swiper-button-prev bg-white shadow-md rounded-full w-10 h-10 flex items-center justify-center text-gray-700 hover:bg-gray-100 transition absolute top-1/2 -translate-y-1/2 left-2 z-10"></div>
      {% endif %}
    </div>

  {% elsif collections['frontpage'].products.size > 0 and reference_product_id == nil %}
    <!-- Fallback -->
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center mb-8">
        <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Recommended for you</h2>
      </div>
      
      {% assign layout_class = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-' | append: item_in_row | append: ' gap-6' %}
      {% if swiper %}{% assign layout_class = swiper_class %}{% endif %}
      
      <div class="{{ layout_class }}">
        {% if swiper %}<div class="swiper-wrapper">{% endif %}
          {% for product in collections['frontpage'].products limit:4 %}
            <div class="swiper-slide flex justify-center items-center">
              {%- render 'product-card', product: product -%}
            </div>
          {% endfor %}
        {% if swiper %}</div>{% endif %}
      </div>

      {% if pagination_row and swiper %}
        <div class="{{ next_button_class }} swiper-button-next bg-white shadow-md rounded-full w-10 h-10 flex items-center justify-center text-gray-700 hover:bg-gray-100 transition absolute top-1/2 -translate-y-1/2 right-2 z-10"></div>
        <div class="{{ prev_button_class }} swiper-button-prev bg-white shadow-md rounded-full w-10 h-10 flex items-center justify-center text-gray-700 hover:bg-gray-100 transition absolute top-1/2 -translate-y-1/2 left-2 z-10"></div>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const section = document.querySelector('.product-recommendations');
  if (!section) return;

  const url = section.dataset.url;
  
  if (url && !section.querySelector('.swiper-slide')) {
    fetch(url)
      .then(res => res.text())
      .then(htmlText => {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlText;
        const newContent = tempDiv.querySelector('.product-recommendations');

        if (newContent && newContent.innerHTML.trim() !== '') {
          section.innerHTML = newContent.innerHTML;
        }

        const swiperContainer = section.querySelector(".{{ my_swiper_class }}");
        if (swiperContainer) {
          new Swiper(swiperContainer, {
            slidesPerView: {{ item_in_row | json }},
            spaceBetween: 20,
            loop: false,
            navigation: {
              nextEl: ".{{ next_button_class }}",
              prevEl: ".{{ prev_button_class }}"
            },
          });
        }
      })
      .catch(console.error);
  }
});
</script>


{% schema %}
{
  "name": "Product recommendations",
  "settings": [
    { "type": "checkbox", "id": "swiper_view", "label": "Swiper View", "default": false },
    { "type": "range", "id": "item_in_row", "min": 3, "max": 5, "step": 1, "label": "Item In Row", "default": 3 },
    { "type": "checkbox", "id": "show_pagination_row", "label": "Show Pagination Row", "default": true }
  ],
  "presets": [{ "name": "Product recommendations" }]
}
{% endschema %}